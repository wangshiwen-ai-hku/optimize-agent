# 引用格式指南

## 概述

在使用 Tutor 模式时，Agent 会从材料中检索信息并引用来源。为了让回答更加专业和易读，我们要求 Agent 使用**读者友好的引用格式**，而不是技术性的内部标识。

## 问题背景

### 不良引用示例 ❌

```
这类问题在物理、化学、生物、工程和金融等多个领域中扮演着关键角色，
但其数值求解却面临着巨大的挑战。具体来说，这些挑战主要体现在以下几个方面
（参考 Chunk 0，第 1 页）：

该材料提出了两种加速原对偶方法的技术（参考 Chunk 0，第 1 页）：
```

**问题**：
- "Chunk 0" 是内部技术标识
- 读者不知道 "Chunk" 是什么
- 不专业，影响阅读体验

### 良好引用示例 ✅

```
这类问题在物理、化学、生物、工程和金融等多个领域中扮演着关键角色，
但其数值求解却面临着巨大的挑战。具体来说，这些挑战主要体现在以下几个方面
（参考第 1 页）：

该材料提出了两种加速原对偶方法的技术（见第 1 页）：
```

**优点**：
- 使用页码，清晰明确
- 专业规范
- 易于读者查找

## 引用格式规范

### 1. 页码引用

✅ **推荐格式**：

```
- 根据第 5 页的内容...
- 如第 10 页所述...
- 在第 3 页中提到...
- 参考第 7 页
- 见第 2 页
- （第 15 页）
```

❌ **避免使用**：

```
- 根据 Chunk 13...
- 如 Chunk 0 所述...
- 在 chunk_id=25 中...
- 参考 Chunk 7
```

### 2. 章节引用

✅ **推荐格式**：

```
- 在第一章中...
- 第二章讨论了...
- 根据第三章的内容...
- 如第四章所述...
```

### 3. 多处引用

✅ **推荐格式**：

```
- 根据第 3 页和第 5 页的内容...
- 在第 2-4 页中详细讨论了...
- 参考第 1 页、第 7 页和第 10 页
```

### 4. 自然引用

✅ **推荐格式**：

```
- 材料中提到...
- 文档指出...
- 根据材料的说明...
- 如材料所述...
```

当不需要精确页码时，可以使用这种自然引用。

## 实现机制

### 1. 工具输出格式

搜索结果格式：

```python
[结果 1] 第 5 页
线性规划是运筹学的一个重要分支...
(内部标识: chunk_13)
```

- 主要显示页码
- 内部标识放在括号中，仅供工具调用使用

### 2. Agent 提示词

```yaml
CITATION GUIDELINES (VERY IMPORTANT):
- When referencing materials, ALWAYS use reader-friendly citations like "第 X 页"
- NEVER use technical identifiers like "Chunk 0", "chunk_id" in your final answer
- The internal chunk IDs are only for your tool calls, not for the reader
```

### 3. 初始指令

```python
CITATION FORMAT (CRITICAL):
- In your FINAL ANSWER, cite sources using "第 X 页" or "第 X 章"
- DO NOT use "Chunk X" in your final answer
- Make your answer readable and professional for students
```

## 工作流程

```
1. 用户提问
   ↓
2. Agent 使用工具检索
   - keyword_search → 返回结果（显示页码）
   - get_chunk_by_id(13) → 返回 "第 5 页的内容：..."
   ↓
3. Agent 整理信息
   - 记住页码信息
   - 准备引用格式
   ↓
4. Agent 生成回答
   - 使用 "第 5 页" 而不是 "Chunk 13"
   - 自然流畅的引用
   ↓
5. 返回最终答案
   - 专业规范
   - 易于阅读
```

## 示例对比

### 示例 1：定义查询

**问题**：什么是线性规划？

❌ **不良回答**：
```
根据 Chunk 0 的内容，线性规划（Linear Programming, LP）是运筹学中的一个重要分支。
在 Chunk 5 中进一步说明了...
```

✅ **良好回答**：
```
根据第 1 页的内容，线性规划（Linear Programming, LP）是运筹学中的一个重要分支。
在第 3 页中进一步说明了...
```

### 示例 2：复杂查询

**问题**：文档中提到了哪些关键的方程组？

❌ **不良回答**：
```
根据 Chunk 13，文档中的关键方程组包括：
1. (4.1)-(4.2)：在 Chunk 13 中定义
2. (4.3)：在 Chunk 25 中说明
```

✅ **良好回答**：
```
根据第 5 页的内容，文档中的关键方程组包括：
1. (4.1)-(4.2)：原始优化问题的标准形式（第 5 页）
2. (4.3)：primal-dual 方法的迭代公式（第 8 页）
```

### 示例 3：综合说明

**问题**：primal-dual 方法的主要挑战是什么？

❌ **不良回答**：
```
根据 Chunk 0，主要挑战包括：
- 非光滑目标泛函（Chunk 0）
- 高维和病态系统（Chunk 0）
```

✅ **良好回答**：
```
根据第 1 页的内容，主要挑战包括：
- 非光滑目标泛函
- 高维和病态系统

这些挑战在材料的第一章中有详细讨论。
```

## 测试验证

### 运行测试

```bash
python test_citation_format.py
```

### 检查要点

1. **技术性引用检测**
   - 搜索 "Chunk" 关键词
   - 搜索 "chunk_id" 关键词
   - 应该为 0 个

2. **友好引用检测**
   - 搜索 "第 X 页" 模式
   - 搜索 "第 X 章" 模式
   - 应该 > 0 个

3. **自然度评估**
   - 引用是否流畅
   - 是否易于理解
   - 是否专业规范

### 评分标准

| 分数 | 标准 |
|------|------|
| 90-100 | 无技术性引用，多处友好引用，自然流畅 |
| 70-89 | 少量技术性引用，有友好引用 |
| 50-69 | 部分技术性引用，部分友好引用 |
| < 50 | 大量技术性引用，缺少友好引用 |

## 常见问题

### Q: 为什么不能使用 "Chunk X"？

**A**: "Chunk" 是系统内部的技术标识，用于文本分块管理。读者不知道也不需要知道这个概念。使用页码更直观、更专业。

### Q: 如果材料没有页码怎么办？

**A**: 
- 对于文本文件，可以使用 "材料中提到..."
- 对于有章节的文档，使用 "第 X 章"
- 或者使用自然引用 "根据材料的说明..."

### Q: 工具调用时可以使用 chunk_id 吗？

**A**: 可以！chunk_id 是工具调用的必要参数。只是在**最终回答**中不要使用。

```python
# 工具调用 - OK
get_chunk_by_id(chunk_id=13)

# 最终回答 - 不要这样
"根据 Chunk 13..."

# 最终回答 - 应该这样
"根据第 5 页..."
```

### Q: 如何知道 chunk 对应的页码？

**A**: 搜索结果会显示页码：

```
[结果 1] 第 5 页
内容预览...
(内部标识: chunk_13)
```

Agent 应该记住 "chunk_13 在第 5 页"，然后在回答中使用 "第 5 页"。

## 最佳实践

### 1. 精确引用

当引用具体内容时，使用页码：

```
根据第 5 页的定义，线性规划是...
```

### 2. 范围引用

当内容跨越多页时：

```
在第 3-5 页中详细讨论了单纯形法的步骤...
```

### 3. 多处引用

当综合多处信息时：

```
根据第 2 页和第 7 页的内容，我们可以看出...
```

### 4. 自然引用

当不需要精确定位时：

```
材料中提到了三种主要方法...
文档指出这个问题的关键在于...
```

### 5. 混合引用

结合使用不同引用方式：

```
材料在第一章（第 1-3 页）中介绍了基本概念，
在第 5 页给出了具体的算法步骤。
```

## 实施检查清单

- [ ] Agent 提示词包含引用格式要求
- [ ] 工具输出显示页码而不是 chunk_id
- [ ] 初始消息强调引用格式
- [ ] 测试脚本验证引用格式
- [ ] 文档说明引用规范
- [ ] 示例展示正确引用方式

## 参考

- [学术引用规范](https://www.citethisforme.com/)
- [技术文档写作指南](https://developers.google.com/style)
- [可读性原则](https://www.plainlanguage.gov/)
